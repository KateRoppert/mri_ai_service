# ИИ-сервис для автоматической диагностики МРТ-изображений

**Разработчик:** Ропперт Екатерина Ивановна (Новосибирский Государственный Университет, Факультет Информационных Технологий)
**Научные руководители:** Павловский Е.Н., Тучинов Б.Н.

---

## Описание проекта

Данный проект представляет собой ИИ-сервис, предназначенный для комплексной автоматизированной обработки и анализа магнитно-резонансных томограмм (МРТ) головного мозга. Сервис реализует многоэтапный конвейер (пайплайн) обработки данных, начиная от загрузки "сырых" DICOM-файлов и заканчивая получением сегментационных масок патологических очагов и отчетов о качестве изображений.

Основная цель проекта — предоставить инструмент для:
1.  Стандартизации и организации МРТ-данных в формат BIDS.
2.  Автоматизированной оценки качества изображений.
3.  Выполнения предобработки данных для подготовки их к анализу моделями ИИ.
4.  Автоматической сегментации патологических очагов головного мозга с использованием моделей глубокого обучения.
5.  Упрощения процесса подготовки датасетов для исследований и обучения ИИ-моделей.

Проект был разработан в рамках выпускной квалификационной работы магистра.

## Ключевые возможности

*   **Автоматическая реорганизация DICOM в BIDS:** Преобразование произвольной структуры входных DICOM-файлов в BIDS-совместимый формат с автоматическим определением модальностей (T1w, T1c, T2w, T2-FLAIR).
*   **Валидация данных:** Проверка соответствия DICOM-файлов стандарту и валидация полученной BIDS-структуры.
*   **Извлечение метаданных:** Сбор и сохранение подробной метаинформации из DICOM-заголовков.
*   **Конвертация в NIfTI:** Преобразование DICOM-файлов в формат NIfTI.
*   **Оценка качества изображений:**
    *   **Быстрая оценка:** Расчет базовых метрик качества (SNR, CNR, FBER, EFC, анизотропия).
    *   **Углубленный анализ с MRIQC:** Интеграция с инструментом MRIQC для детальной оценки качества (может выполняться локально или на удаленном сервере).
    *   **Интерпретация результатов MRIQC:** Автоматическая генерация текстовых резюме по отчетам MRIQC.
*   **Предобработка изображений:** Включает нормализацию интенсивности, коррекцию поля смещения, пространственную регистрацию на шаблон MNI и удаление черепа (skull stripping).
*   **Сегментация патологий:** Отправка запроса на специализированный сервер для сегментации очагов с использованием модели nnU-Net (или аналогичной).
*   **Веб-интерфейс:** Пользовательский интерфейс на Flask для загрузки данных, отслеживания статуса обработки и доступа к результатам.
*   **Конфигурируемость:** Гибкая настройка всех этапов пайплайна через YAML-конфигурационный файл.
*   **Подробное логирование:** Ведение логов для каждого этапа обработки и общего лога пайплайна.

## Структура проекта

mri_ai_service/
├── config/ # Конфигурационные файлы (например, config.yaml)
├── pipeline/ # Основной управляющий скрипт пайплайна
│ └── run_pipeline.py
├── scripts/ # Скрипты для отдельных этапов обработки
│ ├── reorganize_folders.py
│ ├── dicom_standard_check.py
│ ├── extract_metadata.py
│ ├── convert_dicom_to_nifti.py
│ ├── bids_validation.py
│ ├── quality_metrics.py
│ ├── mriqc_quality.py
│ ├── mriqc_interpretation.py
│ ├── preprocessing.py
│ └── segmentation.py
├── webapp/ # Код веб-интерфейса (Flask)
│ ├── app.py
│ ├── templates/
│ └── static/
├── tests/ # Тесты (рекомендуется добавить)
│ └── sample_data/ # Пример входных данных для тестирования
├── mni_templates/ # Шаблоны MNI (или другие необходимые атласы)
├── venv/ # Виртуальное окружение Python (добавить в .gitignore)
├── README.md # Этот файл
├── requirements.txt # Список зависимостей Python (рекомендуется создать)
└── .gitignore # Файл для исключения ненужных файлов из Git

      
## Установка и запуск

### 1. Требования

*   Python 3.8+
*   Внешние утилиты (пути к ним настраиваются в `config/config.yaml`):
    *   dcm2niix
    *   dciodvfy
    *   bids-validator (устанавливается через `npm install -g bids-validator`)
    *   MRIQC (если используется локально)
    *   FSL (в частности, утилита `bet`)
*   Доступ к серверу сегментации (URL настраивается в `config/config.yaml`)
*   (Опционально) Доступ по SSH к серверу для удаленного запуска MRIQC.

### 2. Клонирование репозитория

```bash
git clone https://github.com/KateRoppert/mri_ai_service.git
cd mri_ai_service

    

IGNORE_WHEN_COPYING_START
Use code with caution.
IGNORE_WHEN_COPYING_END
3. Настройка виртуального окружения и установка зависимостей

Рекомендуется использовать виртуальное окружение:

      
python -m venv venv
source venv/bin/activate  # для Linux/macOS
# venv\Scripts\activate   # для Windows

    

IGNORE_WHEN_COPYING_START
Use code with caution. Bash
IGNORE_WHEN_COPYING_END

Создайте файл requirements.txt (если его еще нет) со списком необходимых Python-библиотек и установите их:

      
pip install -r requirements.txt```
Примерное содержимое `requirements.txt` может включать:

    

IGNORE_WHEN_COPYING_START
Use code with caution. Bash
IGNORE_WHEN_COPYING_END

pydicom
SimpleITK
ANTsPy (antspyx)
nibabel
numpy
pandas
PyYAML
requests
Flask
и другие...

      
### 4. Конфигурация

Скопируйте `config/config_template.yaml` (если есть) в `config/config.yaml` и отредактируйте его, указав корректные пути к данным, исполняемым файлам, URL серверов и другие параметры для вашего окружения.

**Ключевые параметры для настройки в `config/config.yaml`:**
*   `paths`: `raw_input_dir` (для тестового локального запуска), `output_base_dir`, `template_path`.
*   `executables`: пути к `dcm2niix`, `dciodvfy`, `bids_validator`, `mriqc_local_exec`, `aiaa_server_url`.
*   `steps`: параметры для каждого этапа, включая флаги `enabled`.
*   `server_mriqc`: параметры для подключения к удаленному серверу MRIQC.

### 5. Запуск веб-интерфейса

```bash
python webapp/app.py

    

IGNORE_WHEN_COPYING_START
Use code with caution.
IGNORE_WHEN_COPYING_END

После запуска откройте веб-браузер и перейдите по адресу, указанному в консоли (обычно http://127.0.0.1:5001).
6. Запуск пайплайна из командной строки (для отладки/разработки)

      
python pipeline/run_pipeline.py --config config/config.yaml --input_data_dir /путь/к/вашим/тестовым_dicom_данным

    

IGNORE_WHEN_COPYING_START
Use code with caution. Bash
IGNORE_WHEN_COPYING_END

Доступны и другие аргументы командной строки (см. --help).
Использование

    Через веб-интерфейс:

        Загрузите ZIP-архив с DICOM-файлами одного пациента.

        Пайплайн обработки запустится автоматически.

        Отслеживайте статус на странице запуска.

        По мере готовности данных, станут доступны кнопки для запуска опциональных шагов (MRIQC, сегментация).

        Скачивайте или просматривайте результаты (отчеты, маски).

    Из командной строки:

        Основной пайплайн (run_pipeline.py) можно использовать для пакетной обработки или интеграции в другие системы.

        Отдельные скрипты из папки scripts/ могут быть запущены для выполнения специфических задач.

Логирование

    Веб-приложение: Логи сохраняются в webapp/logs_webapp/webapp.log.

    Основной пайплайн: Общий лог для каждого запуска сохраняется в <output_base_dir>/<run_id>/logs/pipeline.log.

    Отдельные этапы: Каждый скрипт пайплайна также создает свой лог-файл в <output_base_dir>/<run_id>/logs/.

    MRIQC (при удаленном запуске): Логи с сервера копируются в директорию логов запуска.

    Сегментация: Индивидуальные логи для каждой сессии сохраняются в поддиректорию логов.

Дальнейшее развитие и возможные улучшения

(Здесь можно перечислить идеи из раздела "Обсуждение возможных улучшений" вашей диссертации, например: параллельная обработка, интерполяция, более универсальное определение модальностей, добавление новых ИИ-моделей и т.д.)
Лицензия

(Укажите лицензию, если она есть, например, MIT, Apache 2.0. Если нет, можно написать "Проект предоставляется как есть" или проконсультироваться с руководителями.)

Автор: Ропперт Екатерина Ивановна